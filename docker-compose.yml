version: "3.8"

name: comic-reader

services:
  # Main Bun application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: comic-reader-app
    environment:
      # Container mode paths
      - DB_DIR=/app/db
      - MANGA_DIR=/app/manga
      - MANGA_OCR_SOCKET=/app/sock/manga-ocr.sock
      # API Keys
      - DEEPL_API_KEY=${DEEPL_API_KEY}
    volumes:
      # Manga uploads directory
      - ${DATA_DIR:-./data}/manga:/app/manga
      # Database directory
      - ${DATA_DIR:-./data}/db:/app/db
      # Shared sockets directory (for IPC with manga-ocr)
      - ${DATA_DIR:-./data}/sock:/app/sock
    ports:
      - "${SERVER_PORT:-3000}:3000"
    networks:
      - comic-reader-network
    depends_on:
      manga-ocr:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bun", "run", "/usr/local/bin/healthcheck.ts"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Manga OCR service (Python FastAPI server)
  manga-ocr:
    build:
      context: ./manga-ocr
      dockerfile: Dockerfile
    container_name: manga-ocr
    environment:
      # Hugging Face API token (optional)
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      # Persist Hugging Face model cache (~850MB)
      - ${DATA_DIR:-./data}/models:/root/.cache/huggingface/hub
      # Shared sockets directory (for IPC with main app)
      - ${DATA_DIR:-./data}/sock:/app/sock
    networks:
      - comic-reader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "/usr/local/bin/healthcheck.py"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s

networks:
  comic-reader-network:
    driver: bridge
