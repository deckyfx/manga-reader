name: manga-reader

services:
  # Main Bun application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: manga-reader-app
    environment:
      # Container mode paths
      - DB_DIR=/app/db
      - MANGA_DIR=/app/manga
      - MANGA_OCR_SOCKET=/app/sock/manga-ocr.sock
      # API Keys
      - DEEPL_API_KEY=${DEEPL_API_KEY}
    volumes:
      # Manga uploads directory
      - ${DATA_DIR:-./data}/manga:/app/manga
      # Database directory
      - ${DATA_DIR:-./data}/db:/app/db
      # Shared sockets directory (for IPC with manga-ocr)
      - ${DATA_DIR:-./data}/sock:/app/sock
    ports:
      - "${SERVER_PORT:-3000}:3000"
    networks:
      - manga-reader-network
    depends_on:
      - manga-ocr
    healthcheck:
      test: ["CMD", "bun", "run", "/usr/local/bin/healthcheck.ts"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Manga OCR service (Python FastAPI server)
  manga-ocr:
    build:
      context: ./manga-ocr
      dockerfile: Dockerfile
    container_name: manga-ocr
    environment:
      # Hugging Face API token (optional)
      - HF_TOKEN=${HF_TOKEN}
    volumes:
      # Persist Hugging Face model cache (~850MB manga-ocr + ~197MB AnimeLaMa + ~25MB YOLO manga text detector)
      - ${DATA_DIR:-./data}/models:/root/.cache/huggingface/hub
      # Shared sockets directory (for IPC with main app)
      - ${DATA_DIR:-./data}/sock:/app/sock
    networks:
      - manga-reader-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "/usr/local/bin/healthcheck.py"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 120s

networks:
  manga-reader-network:
    driver: bridge
